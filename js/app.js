// Generated by CoffeeScript 1.12.7
(function() {
  var generate_style, palette, state_buffer_max_length,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  palette = ["b58900", "cb4b16", "dc322f", "d33682", "6c71c4", "268bd2", "2aa198", "859900"];

  state_buffer_max_length = 20;

  generate_style = function() {
    return new cytoscape.stylesheet().selector('node').style({
      'background-color': 'black',
      'shape': 'rectangle'
    }).selector('.node-domain').style({
      'background-color': 'black',
      'border-color': 'black',
      'border-style': 'solid',
      'border-width': '0.5px',
      'width': 30,
      'height': 30
    }).selector('.node-range').style({
      'background-color': 'white',
      'border-color': 'black',
      'border-style': 'solid',
      'border-width': '2px',
      'width': 30,
      'height': 30
    }).selector('.node-role').style({
      'shape': 'diamond',
      'background-color': 'white',
      'border-style': 'solid',
      'border-color': 'black',
      'border-width': '2px',
      'content': 'data(label)',
      'width': 90,
      'color': 'black',
      'height': 60
    }).selector('.node-attribute').style({
      'shape': 'ellipse',
      'background-color': 'white',
      'border-style': 'solid',
      'border-color': 'black',
      'border-width': '2px',
      'content': 'data(label)',
      'width': 30,
      'color': 'black',
      'height': 30
    }).selector('.node-variable').style({
      'shape': 'ellipse',
      'background-color': function(ele) {
        return ele.data('color');
      },
      'width': function(ele) {
        return 100;
      },
      'height': function(ele) {
        return 100;
      },
      'text-valign': 'center',
      'font-size': '40',
      'font-family': "Courier New",
      'color': 'white',
      'text-outline-color': 'black',
      'text-outline-width': '2px',
      'content': 'data(label)'
    }).selector('.node-concept').style({
      'shape': 'rectangle',
      'background-color': 'white',
      'content': 'data(label)',
      'text-valign': 'center',
      'width': function(ele) {
        return ele.data('label').length * 10;
      },
      'height': '30',
      'border-color': '#000',
      'border-width': '2px',
      'border-style': 'solid'
    }).selector('node.highlight').style({
      'border-color': '#333',
      'border-opacity': '0.5',
      'border-width': '20px',
      'border-style': 'solid'
    }).selector('node:selected').style({
      'border-color': '#daa',
      'border-opacity': '0.5',
      'border-width': '20px',
      'border-style': 'solid'
    }).selector(':parent').style({
      'background-image': 'resources/background-circle.svg',
      'background-opacity': '0',
      'background-width': '100%',
      'background-height': '100%',
      'shape': 'rectangle',
      'border-color': 'white'
    });
  };

  window.SparqlText = (function() {
    var cy, div_sparql_text, links, select_boxes;

    select_boxes = [];

    div_sparql_text = null;

    cy = null;

    links = null;

    function SparqlText(cy, links) {
      this.update = bind(this.update, this);
      this.create_dragslot = bind(this.create_dragslot, this);
      this.dragslot_drop = bind(this.dragslot_drop, this);
      this.copy_to_clipboard = bind(this.copy_to_clipboard, this);
      this.generate_plaintext_query = bind(this.generate_plaintext_query, this);
      this.remove_from_select_boxes = bind(this.remove_from_select_boxes, this);
      this.create_highlighting_box = bind(this.create_highlighting_box, this);
      div_sparql_text = document.getElementById('sparql_textbox');
      div_sparql_text.className = "unselectable";
      this.cy = cy;
      this.links = links;
    }

    SparqlText.prototype.add_to_select = function(id) {
      select_boxes.push(id);
      return this.update();
    };

    SparqlText.prototype.create_tab = function() {
      var nbsp;
      nbsp = document.createElement('div');
      nbsp.innerHTML = '&nbsp;';
      return nbsp;
    };

    SparqlText.prototype.rename = function(st) {
      var i, j, node, ref;
      node = this.cy.getElementById(st.dataset.node_id);
      for (i = j = 0, ref = select_boxes.length; 0 <= ref ? j < ref : j > ref; i = 0 <= ref ? ++j : --j) {
        if (select_boxes[i] === st.dataset.prevname) {
          select_boxes[i] = st.innerHTML.substr(i);
        }
      }
      node.data('label', st.innerHTML.substr(1));
      return console.log(st.innerHTML);
    };

    SparqlText.prototype.create_highlighting_box = function(node) {

      /** creates a box in the sparql text that helps locate in the graph where the node is */
      var container, minicross, st;
      container = document.createElement('div');
      container.className = 'highlighting_box_container';
      st = document.createElement('div');
      st.className = "highlighting_box";
      st.id = node.id() + Math.round(Math.random() * 1000);
      st.dataset.prevname = node.id();
      st.dataset.node_id = node.id();
      st.setAttribute('draggable', true);
      st.setAttribute('contenteditable', 'true');
      st.addEventListener('dragstart', function(ev) {
        return ev.dataTransfer.setData("text", ev.target.id);
      });
      st.onkeyup = (function(_this) {
        return function() {
          return _this.rename(st);
        };
      })(this);
      st.onmouseover = function($) {
        return node.addClass("highlight");
      };
      st.onmouseout = function($) {
        return node.removeClass("highlight");
      };
      st.onclick = (function(_this) {
        return function($) {
          _this.cy.nodes().unselect();
          return node.select();
        };
      })(this);
      st.innerHTML = "?" + node.data('label');
      st.style.backgroundColor = node.data('color');
      container.append(st);
      minicross = document.createElement('div');
      minicross.innerHTML = ' x ';
      minicross.className = 'minicross';
      minicross.dataset.linkedhbox = st.id;
      minicross.dataset.node_id = st.dataset.node_id;
      minicross.style.display = 'none';
      minicross.onclick = (function(_this) {
        return function($) {
          return _this.remove_from_select_boxes(minicross.dataset.node_id);
        };
      })(this);
      container.append(minicross);
      container.onmouseover = function($) {
        return minicross.style.display = 'inline-block';
      };
      container.onmouseout = function($) {
        return minicross.style.display = 'none';
      };
      return container;
    };

    SparqlText.prototype.remove_from_select_boxes = function(node_id) {
      select_boxes = select_boxes.filter(function(elem) {
        return elem !== node_id;
      });
      return this.update();
    };

    SparqlText.prototype.generate_plaintext_query = function() {

      /** warning: VERY HACKY */
      var count, d, elem, j, k, l, len, len1, len2, ref, ref1, result;
      result = "Select ";
      if (select_boxes.length === 0) {
        result += '*';
      } else {
        for (j = 0, len = select_boxes.length; j < len; j++) {
          elem = select_boxes[j];
          result += '?' + elem + ' ';
        }
      }
      result += '\r\nwhere {';
      ref = document.getElementsByClassName('q_line');
      for (k = 0, len1 = ref.length; k < len1; k++) {
        elem = ref[k];
        result += '\r\n';
        count = 0;
        ref1 = elem.getElementsByClassName('highlighting_box');
        for (l = 0, len2 = ref1.length; l < len2; l++) {
          d = ref1[l];
          result += d.innerHTML + ' ';
          count += 1;
          if (count % 3 === 0) {
            result += ' .\r\n';
          }
        }
      }
      result += '}';
      console.log(result);
      return result;
    };

    SparqlText.prototype.copy_to_clipboard = function() {

      /** ugly hack to make you able to copy text to clipboard.
       */
      var thing, tmp_div;
      tmp_div = document.createElement('textarea');
      tmp_div.value = this.generate_plaintext_query();
      tmp_div.id = "tmp_div";
      document.body.appendChild(tmp_div);
      thing = document.getElementById('tmp_div');
      thing.select();
      document.execCommand('Copy');
      tmp_div.style.display = 'none';
      return document.body.removeChild(tmp_div);
    };

    SparqlText.prototype.dragslot_drop = function(ev, index) {
      var data, this_element_id;
      ev.preventDefault();
      data = ev.dataTransfer.getData("text");
      this_element_id = document.getElementById(data).dataset.node_id;
      select_boxes.splice(select_boxes.indexOf(this_element_id), 1);
      console.log(index);
      select_boxes.splice(index, 0, this_element_id);
      return this.update();
    };

    SparqlText.prototype.create_dragslot = function(index) {
      var nbsp;
      nbsp = document.createElement('div');
      nbsp.className = 'dragslot_select';
      nbsp.dataset.index = index;
      nbsp.addEventListener('dragover', function(ev) {
        var ds, j, len, ref, results;
        ev.preventDefault();
        ref = document.getElementsByClassName('dragslot_select');
        results = [];
        for (j = 0, len = ref.length; j < len; j++) {
          ds = ref[j];
          results.push(ds.style.opacity = 1);
        }
        return results;
      });
      nbsp.addEventListener('drop', (function(_this) {
        return function(ev) {
          return _this.dragslot_drop(ev, nbsp.dataset.index);
        };
      })(this));
      nbsp.innerHTML = '&nbsp;&nbsp;';
      return nbsp;
    };

    SparqlText.prototype.update = function() {
      var count, elem, f, f_string, init_string, j, k, len, len1, link, q_line, ref, s_line, select_div, select_div_f;
      div_sparql_text.innerHTML = "";
      init_string = document.createElement('div');
      init_string.className = "init_string";
      s_line = document.createElement('div');
      s_line.className = "s_line";
      if (select_boxes.length === 0) {
        s_line.innerHTML = "&nbsp;*";
      } else {
        s_line.append(this.create_tab());
        count = 0;
        for (j = 0, len = select_boxes.length; j < len; j++) {
          elem = select_boxes[j];
          s_line.append(this.create_highlighting_box(this.cy.getElementById(elem)));
          s_line.append(this.create_dragslot(count));
          count += 1;
        }
      }
      select_div = document.createElement('div');
      select_div.innerHTML = "Select ";
      init_string.append(select_div);
      init_string.append(s_line);
      init_string.append(document.createElement('br'));
      select_div_f = document.createElement('div');
      select_div_f.innerHTML = " where {";
      init_string.append(select_div_f);
      div_sparql_text.append(init_string);
      q_line = document.createElement('div');
      q_line.className = "q_line";
      ref = this.links;
      for (k = 0, len1 = ref.length; k < len1; k++) {
        link = ref[k];
        if (link.link_type === 'concept') {
          q_line.append(this.create_highlighting_box(link.node_var1));
          f = document.createElement("div");
          f.innerHTML = "&nbsp;rdf:type " + link.node_concept.data('label') + " .";
          q_line.append(f);
          q_line.append(document.createElement('br'));
        } else {
          q_line.append(this.create_highlighting_box(link.source));
          q_line.append(this.create_tab());
          q_line.append(this.create_highlighting_box(link.node_link));
          q_line.append(this.create_tab());
          q_line.append(this.create_highlighting_box(link.target));
          f = document.createElement("div");
          f.innerHTML = " .";
          q_line.append(f);
          q_line.append(document.createElement('br'));
        }
      }
      div_sparql_text.append(q_line);
      f_string = document.createElement('div');
      f_string.innerHTML = '}';
      return div_sparql_text.append(f_string);
    };

    return SparqlText;

  })();

  window.PainlessLink = (function() {
    var cy, link_name, link_type, node_concept, node_link, node_quad1, node_quad2, node_var1, node_var2;

    cy = null;

    node_var1 = null;

    node_var2 = null;

    node_quad1 = null;

    node_quad2 = null;

    node_link = null;

    node_concept = null;

    link_name = null;

    link_type = null;

    function PainlessLink(cy, link_name, link_type, node_var1, node_var2) {
      if (node_var1 == null) {
        node_var1 = null;
      }
      if (node_var2 == null) {
        node_var2 = null;
      }
      this.create_concept = bind(this.create_concept, this);
      this.create_link = bind(this.create_link, this);
      this.create_node = bind(this.create_node, this);
      this.reverse = bind(this.reverse, this);
      this.create_edge = bind(this.create_edge, this);
      this.cy = cy;
      this.link_name = link_name;
      this.link_type = link_type;
      this.node_var1 = node_var1;
      this.node_var2 = node_var2;
      this.node_quad1 = null;
      this.node_quad2 = null;
      if (link_type === 'concept') {
        this.create_concept();
      } else {
        this.create_link();
      }
    }

    PainlessLink.prototype.find_new_name = function() {
      var x;
      x = 0;
      while (this.cy.getElementById("x" + x).length !== 0) {
        x += 1;
      }
      return "x" + x;
    };

    PainlessLink.prototype.create_edge = function(node1, node2) {
      return this.cy.add({
        group: 'edges',
        data: {
          source: node1.id(),
          target: node2.id()
        }
      });
    };

    PainlessLink.prototype.reverse = function() {

      /** can only be applied to non-concept relationships */
      if (this.node_quad1.hasClass('node-range')) {
        this.node_quad1.classes('node-domain');
        this.source = this.node_var2;
        this.target = this.node_var1;
        return this.node_quad2.classes('node-range');
      } else {
        this.node_quad1.classes('node-range');
        this.node_quad2.classes('node-domain');
        this.source = this.node_var1;
        return this.target = this.node_var2;
      }
    };

    PainlessLink.prototype.create_node = function(type, label) {
      var data;
      if (label == null) {
        label = null;
      }
      data = {};
      if (type === 'node-variable' && label === null) {
        label = this.find_new_name();
        data['id'] = label;
        data['color'] = '#' + palette[label.substr(1) % palette.length];
      }
      if (type === 'node-concept') {
        data['label'] = this.link_name;
      } else {
        data['label'] = label;
      }
      data['links'] = this;
      return this.cy.add({
        group: 'nodes',
        data: data,
        classes: type
      });
    };

    PainlessLink.prototype.create_link = function() {
      if (this.node_var1 === null) {
        this.node_var1 = this.create_node('node-variable');
      }
      if (this.node_var2 === null) {
        this.node_var2 = this.create_node('node-variable');
      }
      this.node_quad1 = this.create_node('node-range');
      this.node_quad2 = this.create_node('node-domain');
      this.source = this.node_var1;
      this.target = this.node_var2;
      if (this.link_type === 'role') {
        this.node_link = this.create_node('node-role', this.link_name);
      } else {
        this.node_link = this.create_node('node-attribute', this.link_name);
      }
      this.create_edge(this.node_var2, this.node_quad2);
      this.create_edge(this.node_quad1, this.node_link);
      this.create_edge(this.node_link, this.node_quad2);
      return this.create_edge(this.node_var1, this.node_quad1);
    };

    PainlessLink.prototype.create_concept = function() {
      if (this.node_var1 === null) {
        this.node_var1 = this.create_node('node-variable');
      }
      this.node_concept = this.create_node('node-concept');
      return this.create_edge(this.node_var1, this.node_concept);
    };

    return PainlessLink;

  })();

  window.PainlessGraph = (function() {

    /** manages the graph visualization
        TODO: palette should be in constants
        TODO: hardcoded collision distance should be in constants
     */
    var links, state_buffer;

    state_buffer = null;

    links = [];

    function PainlessGraph() {
      this.init = bind(this.init, this);
      this.check_collisions = bind(this.check_collisions, this);
      this.add_link = bind(this.add_link, this);
      this.delete_node = bind(this.delete_node, this);
      this.reverse_relationship = bind(this.reverse_relationship, this);
      this.cleanup_unlinked_variables = bind(this.cleanup_unlinked_variables, this);
      this.add_to_select = bind(this.add_to_select, this);
      this.center_view = bind(this.center_view, this);
      this.reshape = bind(this.reshape, this);

      /**
      TODO: sparql_text should be managed by painless_sparql.coffee
       */
      this.init();
      this.reshape();
      this.sparql_text = new SparqlText(this.cy, links);
      this.sparql_text.update();
    }

    PainlessGraph.prototype.reshape = function() {

      /** resets node positions in the graph view */
      return this.cy.layout({
        name: 'cola',
        fit: false,
        refresh: 2,
        maxSimulationTime: 2000,
        avoidOverlap: false
      }).run();
    };

    PainlessGraph.prototype.center_view = function() {

      /** 
      TODO: pan and center should actually be two different buttons!
       */
      if (this.cy.nodes(':selected').length > 0) {
        return this.cy.center(this.cy.nodes(':selected'));
      } else {
        return this.cy.fit();
      }
    };

    PainlessGraph.prototype.add_to_select = function(node_id) {
      return this.sparql_text.add_to_select(node_id);
    };

    PainlessGraph.prototype.copy_to_clipboard = function() {
      return this.sparql_text.copy_to_clipboard();
    };

    PainlessGraph.prototype.save_state = function() {
      if (state_buffer === null) {
        state_buffer = [];
      }
      if (this.cy.json() !== state_buffer[state_buffer.length - 1]) {
        state_buffer.push(this.cy.json());
      }
      if (state_buffer.length >= state_buffer_max_length) {
        return state_buffer.shift();
      }
    };

    PainlessGraph.prototype.undo = function() {
      if (state_buffer === null || state_buffer.length < 1) {
        return console.warn("no saved states");
      } else {
        this.cy.json(state_buffer[state_buffer.length - 1]);
        this.cy.style(generate_style());
        state_buffer.pop();
        return this.reshape();
      }
    };

    PainlessGraph.prototype.cleanup_unlinked_variables = function() {
      var j, len, node, ref, results;
      ref = this.cy.nodes('.node-variable');
      results = [];
      for (j = 0, len = ref.length; j < len; j++) {
        node = ref[j];
        if (node.neighborhood('node').length === 0) {
          this.cy.remove(node);
          results.push(this.sparql_text.remove_from_select_boxes(node.id()));
        } else {
          results.push(void 0);
        }
      }
      return results;
    };

    PainlessGraph.prototype.reverse_relationship = function() {
      var s_node;
      s_node = this.cy.nodes(":selected");
      if (s_node === null) {
        return console.warn('please select a node in the sparql graph');
      } else if (s_node.hasClass("node-variable")) {
        return console.warn('please select a role and not a variable');
      } else if (s_node.data('links').link_type === 'attribute') {
        return console.warn('attributes cannot be reversed');
      } else if (s_node.hasClass("node-role") || s_node.hasClass("node-domain") || s_node.hasClass("node-range")) {
        return this.cy.nodes(":selected").data('links').reverse();
      } else {
        return console.warn('this action cannot be performed on the selected node');
      }
    };

    PainlessGraph.prototype.delete_node = function() {
      var j, k, l, len, len1, len2, len3, len4, m, n, node, node2, node3, node4, ref, ref1, ref2, ref3, ref4;
      this.save_state();
      ref = this.cy.nodes(':selected');
      for (j = 0, len = ref.length; j < len; j++) {
        node = ref[j];
        if (node.hasClass('node-variable')) {
          ref1 = node.neighborhood('node');
          for (k = 0, len1 = ref1.length; k < len1; k++) {
            node2 = ref1[k];
            ref2 = node2.neighborhood('node');
            for (l = 0, len2 = ref2.length; l < len2; l++) {
              node3 = ref2[l];
              ref3 = node3.neighborhood('node');
              for (m = 0, len3 = ref3.length; m < len3; m++) {
                node4 = ref3[m];
                this.cy.remove(node4);
              }
              this.cy.remove(node3);
            }
            this.cy.remove(node2);
          }
          this.cy.remove(node);
          this.sparql_text.remove_from_select_boxes(node.id());
        }
        if (node.hasClass('node-attribute')) {
          ref4 = node.neighborhood('node');
          for (n = 0, len4 = ref4.length; n < len4; n++) {
            node2 = ref4[n];
            this.cy.remove(node2);
          }
          this.cy.remove(node);
        }
      }
      this.cleanup_unlinked_variables();
      return this.reshape();
    };

    PainlessGraph.prototype.merge = function(node1, node2) {

      /** merges node1 and node2, repositioning all node2's edges into node1 */
      var edge, j, len, ref;
      this.save_state();
      ref = node2.neighborhood('edge');
      for (j = 0, len = ref.length; j < len; j++) {
        edge = ref[j];
        if (edge.target().id() === node2.id()) {
          this.cy.add({
            group: 'edges',
            data: {
              source: edge.source().id(),
              target: node1.id()
            }
          });
        }
        if (edge.source().id() === node2.id()) {
          this.cy.add({
            group: 'edges',
            data: {
              source: node1.id(),
              target: edge.target().id()
            }
          });
        }
      }
      this.sparql_text.remove_from_select_boxes(node2.id());
      return this.cy.remove(node2);
    };

    PainlessGraph.prototype.add_link = function(link_name, link_type) {

      /** adds a new link in the graph. 
          links that are not concepts (roles and attributes) add a new variable into the graph.
          links are always added to the selected variable in the graph, if there are no selected variables,   
              two new variables are created.
      
          links can be:
          - concepts   
          - roles
          - attributes
      
          TODO: use an enum to represent link types instead of hardcoded strings
       */
      var link;
      this.save_state();
      if (link_type === 'concept') {
        if (this.cy.nodes(":selected").length > 0 && this.cy.nodes(":selected").hasClass('node-variable')) {
          link = new PainlessLink(this.cy, link_name, link_type, this.cy.nodes(":selected"));
        } else {
          link = new PainlessLink(this.cy, link_name, link_type);
          this.sparql_text.add_to_select(link.node_var1.id());
        }
      } else {
        if (this.cy.nodes(":selected").length > 0 && this.cy.nodes(":selected").hasClass('node-variable')) {

          /** if a var node is selected, the link is added to the var node and one new var node is created */
          link = new PainlessLink(this.cy, link_name, link_type, this.cy.nodes(":selected"));
          this.sparql_text.add_to_select(link.node_var2.id());
        } else {

          /** otherwise, two new var nodes are created */
          link = new PainlessLink(this.cy, link_name, link_type);
          this.sparql_text.add_to_select(link.node_var1.id());
          this.sparql_text.add_to_select(link.node_var2.id());
        }
      }
      links.push(link);
      this.sparql_text.update();
      return this.reshape();
    };

    PainlessGraph.prototype.compute_distance = function(node1, node2) {

      /** computes distance between two node positions */
      var a, b;
      a = Math.abs(node1.position('x') - node2.position('x'));
      b = Math.abs(node1.position('y') - node2.position('y'));
      return Math.sqrt(a * a + b * b);
    };

    PainlessGraph.prototype.check_collisions = function() {

      /** check if there are any collisions in all the node variables
      returns the colliding nodes if there are any.
      
      TODO: collision highlight is broken!
      TODO: remove hardcoded collision distance threshold
       */
      var j, k, len, len1, node, node2, ref, ref1;
      ref = this.cy.nodes(".node-variable");
      for (j = 0, len = ref.length; j < len; j++) {
        node = ref[j];
        ref1 = this.cy.nodes(".node-variable");
        for (k = 0, len1 = ref1.length; k < len1; k++) {
          node2 = ref1[k];
          if (node !== node2) {
            if (this.compute_distance(node, node2) < 100) {
              node.addClass('highlight');
              node2.addClass('highlight');
              return [node, node2];
            } else {
              node.removeClass('highlight');
            }
          }
        }
      }
    };

    PainlessGraph.prototype.init = function() {
      this.cy = new cytoscape({
        container: document.getElementById("query_canvas"),
        style: generate_style(),
        wheelSensitivity: 0.5
      });
      this.cy.on('click', '.node-variable', (function(_this) {
        return function(event) {
          event.target.select();
          return _this.reshape();
        };
      })(this));
      this.cy.on('mouseup', (function(_this) {
        return function($) {
          var node_tmp_arr;
          if (_this.check_collisions() !== void 0) {
            node_tmp_arr = _this.check_collisions();
            _this.merge(node_tmp_arr[0], node_tmp_arr[1]);
          }
          return _this.reshape();
        };
      })(this));
      return this.cy.resize();
    };

    return PainlessGraph;

  })();

  window.PainlessSparql = (function() {
    var painless_graph;

    painless_graph = null;

    function PainlessSparql(graph) {
      this.onkeypress_handler = bind(this.onkeypress_handler, this);
      this.create_sidenav = bind(this.create_sidenav, this);
      this.graph = graph;
      this.cy = graph.cy;
      this.init();
    }

    PainlessSparql.prototype.init = function() {
      this.create_sidenav();
      return this.add_event_listener();
    };

    PainlessSparql.prototype.create_sidenav = function() {
      var button, down_button, menu, mid_button, nav_div, side_nav, slider, slider_range, sparql_textbox, up_button;
      side_nav = document.createElement("div");
      side_nav.id = "sidenav";
      side_nav.className = "sidenav";
      document.body.appendChild(side_nav);
      slider = document.createElement("div");
      slider.className = "slidecontainer";
      slider_range = document.createElement("input");
      slider_range.type = "range";
      slider_range.min = 1;
      slider_range.max = 100;
      slider_range.value = 48;
      slider_range.step = 0.5;
      slider_range.className = 'slider';
      slider.appendChild(slider_range);
      slider_range.oninput = function(s) {
        return side_nav.style.width = (100 - this.value - 2) + "%";
      };
      document.body.appendChild(slider);
      sparql_textbox = document.createElement("div");
      sparql_textbox.id = "sparql_textbox";
      sparql_textbox.innerHTML = "sparql_query_here";
      side_nav.appendChild(sparql_textbox);
      this.query_canvas = document.createElement("div");
      this.query_canvas.id = "query_canvas";
      side_nav.appendChild(this.query_canvas);
      painless_graph = new PainlessGraph(this.query_canvas);
      menu = document.createElement('div');
      menu.id = 'painless_menu';
      document.getElementById('sidenav').append(menu);
      nav_div = document.createElement('div');
      nav_div.id = 'nav_div';
      up_button = document.createElement('div');
      up_button.innerHTML = '▲';
      up_button.className = 'resize_button';
      up_button.onclick = function($) {
        query_canvas.style.height = '80%';
        sparql_textbox.style.height = '0%';
        return query_canvas.style.height = '80%';
      };
      nav_div.append(up_button);
      mid_button = document.createElement('div');
      mid_button.innerHTML = '≡';
      mid_button.className = 'resize_button';
      mid_button.onclick = function($) {
        query_canvas.style.height = '50%';
        return sparql_textbox.style.height = '30%';
      };
      nav_div.append(mid_button);
      down_button = document.createElement('div');
      down_button.innerHTML = '▼';
      down_button.className = 'resize_button';
      down_button.onclick = function($) {
        sparql_textbox.style.height = '80%';
        return query_canvas.style.height = '0%';
      };
      nav_div.append(down_button);
      menu.append(nav_div);
      button = document.createElement('button');
      button.innerHTML = 'undo';
      button.className = 'menu_button';
      button.onclick = (function(_this) {
        return function($) {
          return painless_graph.undo();
        };
      })(this);
      menu.append(button);
      button = document.createElement('button');
      button.innerHTML = 'delete node';
      button.className = 'menu_button';
      button.onclick = function() {
        return painless_graph.delete_node();
      };
      menu.append(button);
      button = document.createElement('button');
      button.innerHTML = 'reverse relationship';
      button.className = 'menu_button';
      button.onclick = function() {
        painless_graph.reverse_relationship();
        return painless_graph.sparql_text.update();
      };
      menu.append(button);
      button = document.createElement('button');
      button.innerHTML = 'rename';
      button.className = 'menu_button';
      menu.append(button);
      button = document.createElement('button');
      button.innerHTML = 'center view';
      button.onclick = function() {
        return painless_graph.center_view();
      };
      button.className = 'menu_button';
      menu.append(button);
      button = document.createElement('button');
      button.innerHTML = 'copy to clipboard';
      button.className = 'menu_button';
      button.onclick = function() {
        return painless_graph.copy_to_clipboard();
      };
      menu.append(button);
      button = document.createElement('button');
      button.innerHTML = 'add to select';
      button.className = 'menu_button';
      button.onclick = function() {
        return painless_graph.add_to_select(painless_graph.cy.nodes(':selected').id());
      };
      menu.append(button);
      button = document.createElement('button');
      button.innerHTML = 'filter';
      button.className = 'menu_button';
      return menu.append(button);
    };

    PainlessSparql.prototype.open_nav = function() {
      return document.getElementById("sidenav").style.width = "50%";
    };

    PainlessSparql.prototype.close_nav = function() {
      return document.getElementById("sidenav").style.width = "0px";
    };

    PainlessSparql.prototype.onkeypress_handler = function(event) {
      var selected_node;
      if (event.key === "a") {
        return this.open_nav();
      } else if (event.key === "b") {
        return this.close_nav();
      } else if (event.key === "c") {
        selected_node = this.cy.nodes(":selected");
        if (selected_node.length === 0) {
          console.warn("please, select a node in the main graph");
        }
        switch (selected_node.data('type')) {
          case "role":
            return painless_graph.add_link(selected_node.data('label'), 'role');
          case "attribute":
            return painless_graph.add_link(selected_node.data('label'), 'attribute');
          case "concept":
            return painless_graph.add_link(selected_node.data('label'), 'concept');
        }
      } else if (event.key === "d") {
        return console.log(this.cy.nodes(":selected").data('type'));
      }
    };

    PainlessSparql.prototype.add_event_listener = function() {
      return document.onkeypress = this.onkeypress_handler;
    };

    return PainlessSparql;

  })();

}).call(this);
